FROM debian:10.11-slim

RUN apt-get update && apt-get install -y \
    gnupg=2.2.12-1+deb10u1 \
    dirmngr=2.2.12-1+deb10u1 \
    make=4.2.1-1.2 \
    git=1:2.20.1-2+deb10u3 \
    wget=1.20.1-1.1 && \
    wget -qO - https://haproxy.debian.net/bernat.debian.org.gpg \
        | gpg --dearmor > /usr/share/keyrings/haproxy.debian.net.gpg && \
    echo deb "[signed-by=/usr/share/keyrings/haproxy.debian.net.gpg]" \
      http://haproxy.debian.net buster-backports-2.5 main \
      > /etc/apt/sources.list.d/haproxy.list && \
    apt-get update && apt-get install -y --no-install-recommends \
    haproxy=2.5.0-1~bpo10+1 && \
    wget --progres=dot:giga https://go.dev/dl/go1.17.3.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.17.3.linux-amd64.tar.gz && \
    rm go1.17.3.linux-amd64.tar.gz && \
    export PATH="${PATH}:/usr/local/go/bin" && \
    git clone https://github.com/haproxytech/dataplaneapi.git && \
    cd dataplaneapi && \
    make build && \
    rm -rf /usr/local/go && \
    apt-get remove -y gnupg dirmngr make git wget && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    ulimit -n 100000

ENV PATH="/dataplaneapi/build:${PATH}"

COPY ./haproxy.cfg /etc/haproxy/haproxy.cfg

# ENTRYPOINT [ "/bin/bash" ]
ENTRYPOINT [ "/usr/sbin/haproxy" ]
CMD [ "-f", "/etc/haproxy/haproxy.cfg" ]
# /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg
